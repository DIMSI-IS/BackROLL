## Licensed to the Apache Software Foundation (ASF) under one
## or more contributor license agreements.  See the NOTICE file
## distributed with this work for additional information
## regarding copyright ownership.  The ASF licenses this file
## to you under the Apache License, Version 2.0 (the
## "License"); you may not use this file except in compliance
## with the License.  You may obtain a copy of the License at
##
##   http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing,
## software distributed under the License is distributed on an
## "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
## KIND, either express or implied.  See the License for the
## specific language governing permissions and limitations
## under the License.


version: "2.3"

services:
  redis:
    restart: always
    image: redis
    command: "redis-server"
    networks:
      - backroll-network
    expose:
      - "6379"
    ports:
      - "6379:6379"

  api:
    restart: always
    image: backend:stable
    command: "python3 run.py"
    volumes:
      - ./ssh:/root/.ssh
    networks:
      - backroll-network
    expose:
      - "5050"
    ports:
      - "5050:5050"
    depends_on:
      - "redis"
    extends:
      file: base.yml
      service: base

  worker_primary:
    restart: always
    image: backend:stable
    command: "celery -A app.celery worker -n worker -Q default --concurrency=4"
    environment:
      - BORG_UNKNOWN_UNENCRYPTED_REPO_ACCESS_IS_OK=yes
    volumes:
      - ./ssh:/root/.ssh
      - /mnt:/mnt
    networks:
      - backroll-network
    depends_on:
      - "api"
    extends:
      file: base.yml
      service: base


  worker_secondary:
    restart: always
    image: backend:stable
    environment:
      - BORG_UNKNOWN_UNENCRYPTED_REPO_ACCESS_IS_OK=yes
    mem_limit: 8g
    command: "celery -A app.celery worker -n worker2 -Q backup_tasks --concurrency=5"
    volumes:
      - ./ssh:/root/.ssh
      - /mnt:/mnt
    networks:
      - backroll-network
    depends_on:
      - "worker_primary"
    extends:
      file: base.yml
      service: base

  flower:
    restart: always
    image: backend:stable
    command: "celery -A app.celery flower --conf=flowerconfig.py"
    networks:
      - backroll-network
    expose:
      - "5555"
    ports:
      - "5555:5555"
    depends_on:
      - "worker_primary"
    extends:
      file: base.yml
      service: base

  beat:
    restart: always
    image: backend:stable
    command: "celery -A app.celery beat -S redbeat.RedBeatScheduler"
    networks:
      - backroll-network
    depends_on:
      - "worker_secondary"
    extends:
      file: base.yml
      service: base

  # front:
  #   restart: always
  #   image: frontend:stable
  #   ports:
  #     - "8080:80"
  #   networks:
  #     - backroll-network
  #   depends_on:
  #     - "api"

networks:
  backroll-network: